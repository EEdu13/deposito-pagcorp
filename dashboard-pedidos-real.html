<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEP√ìSITO DE SALDO PAGCORP - Sistema de Refei√ß√µes</title>
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Sistema de dep√≥sito PAGCORP">
    
    <!-- Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PAGCORP">
    
    <!-- Push Notifications Support -->
    <script>
        // ===== VARI√ÅVEIS GLOBAIS (acess√≠veis em toda a aplica√ß√£o) =====
        window.notificationPermission = false;
        window.lastCheckTimestamp = null;
        window.lastPedidosCount = 0;
        window.monitoringInterval = null;
        window.monitoringActive = false;
        
        // Aliases para facilitar acesso
        let notificationPermission = window.notificationPermission;
        let lastCheckTimestamp = window.lastCheckTimestamp;
        let lastPedidosCount = window.lastPedidosCount;
        let monitoringInterval = window.monitoringInterval;
        let monitoringActive = window.monitoringActive;
        
        // Solicitar permiss√£o para notifica√ß√µes ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            requestNotificationPermission();
        });
        
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                console.log('üîî Solicitando permiss√£o de notifica√ß√£o...');
                const permission = await Notification.requestPermission();
                window.notificationPermission = permission === 'granted';
                notificationPermission = window.notificationPermission;
                
                console.log('üîî Permiss√£o de notifica√ß√£o:', permission, '- Granted:', window.notificationPermission);
                
                if (window.notificationPermission) {
                    showNotification('‚úÖ Notifica√ß√µes ativadas! Monitoramento iniciado automaticamente.', 'success');
                    // Ativar monitoramento automaticamente
                    setTimeout(() => {
                        console.log('üîî Tentando ativar monitoramento autom√°tico...', 'monitoringActive:', window.monitoringActive);
                        if (!window.monitoringActive) {
                            toggleMonitoring();
                        }
                    }, 2000);
                } else {
                    showNotification('‚ö†Ô∏è Permiss√£o de notifica√ß√£o negada. Ative nas configura√ß√µes do navegador.', 'info');
                }
            } else {
                console.log('‚ùå Navegador n√£o suporta notifica√ß√µes');
                showNotification('‚ùå Navegador n√£o suporta notifica√ß√µes', 'error');
            }
        }
        
        function startPedidosMonitoring() {
            if (window.monitoringInterval) {
                clearInterval(window.monitoringInterval);
            }
            
            console.log('üîî Iniciando monitoramento de pedidos...');
            
            // Verificar novos pedidos a cada 10 segundos
            window.monitoringInterval = setInterval(async () => {
                console.log('‚è∞ Executando verifica√ß√£o autom√°tica...', new Date().toLocaleTimeString());
                try {
                    await checkForNewPedidos();
                    console.log('‚úÖ Verifica√ß√£o autom√°tica conclu√≠da');
                } catch (error) {
                    console.error('‚ùå Erro na verifica√ß√£o autom√°tica:', error);
                }
            }, 10000); // 10 segundos
            
            console.log('üîî Monitoramento de pedidos iniciado (10s), interval ID:', window.monitoringInterval);
        }
        
        function stopPedidosMonitoring() {
            if (window.monitoringInterval) {
                clearInterval(window.monitoringInterval);
                window.monitoringInterval = null;
                console.log('üîî Monitoramento de pedidos parado');
            }
        }
        
        async function checkForNewPedidos() {
            if (!window.notificationPermission) return;
            
            try {
                console.log('üîç Verificando novos pedidos...');
                
                // Buscar dados da API
                const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:5000/api/pedidos'
                    : '/api/pedidos';

                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.log('‚ùå Erro na resposta da API:', response.status);
                    return;
                }

                const resultado = await response.json();
                console.log('üìä Dados recebidos da API:', resultado);
                
                if (!resultado.success || !resultado.data) {
                    console.log('‚ùå Estrutura de dados inv√°lida');
                    return;
                }

                console.log('üìà Total de pedidos:', resultado.data.length);

                // Log de TODOS os pedidos para debug
                console.log('üîç TODOS OS PEDIDOS:');
                resultado.data.forEach((pedido, index) => {
                    console.log(`Pedido ${index + 1}:`, {
                        DATA_ENVIO1: pedido.DATA_ENVIO1,
                        FECHAMENTO: pedido.FECHAMENTO,
                        APROVADO_POR: pedido.APROVADO_POR,
                        DEPOSITADO: pedido.DEPOSITADO,
                        RESPONSAVEL_PELO_CARTAO: pedido.RESPONSAVEL_PELO_CARTAO,
                        TOTAL_PAGAR: pedido.TOTAL_PAGAR
                    });
                });

                // Filtrar pedidos sem fechamento e aprovados
                const pedidosNovos = resultado.data.filter(pedido => 
                    pedido.FECHAMENTO !== 'SIM' && 
                    pedido.FECHAMENTO !== 'Sim' && 
                    pedido.FECHAMENTO !== 'sim' &&
                    pedido.APROVADO_POR && 
                    pedido.APROVADO_POR.trim() !== '' &&
                    pedido.DEPOSITADO !== 'DEPOSITADO'
                );
                
                console.log('‚úÖ Pedidos v√°lidos (aprovados e n√£o fechados):', pedidosNovos.length);
                
                // Log de alguns pedidos para debug
                if (pedidosNovos.length > 0) {
                    console.log('üîç Exemplo de pedido:', pedidosNovos[0]);
                    console.log('üîç Campos importantes:', {
                        DATA_ENVIO1: pedidosNovos[0].DATA_ENVIO1,
                        FECHAMENTO: pedidosNovos[0].FECHAMENTO,
                        APROVADO_POR: pedidosNovos[0].APROVADO_POR,
                        DEPOSITADO: pedidosNovos[0].DEPOSITADO,
                        RESPONSAVEL_PELO_CARTAO: pedidosNovos[0].RESPONSAVEL_PELO_CARTAO
                    });
                }

                // Verificar pedidos criados/aprovados nas √∫ltimas 48 horas (para detectar pedidos recentes)
                const recentPedidos = pedidosNovos.filter(pedido => {
                    if (!pedido.DATA_ENVIO1) return false;
                    
                    // SOLU√á√ÉO: Usar UTC para evitar problemas de fuso hor√°rio
                    const pedidoDate = new Date(pedido.DATA_ENVIO1);
                    const pedidoDateUTC = new Date(Date.UTC(
                        pedidoDate.getUTCFullYear(), 
                        pedidoDate.getUTCMonth(), 
                        pedidoDate.getUTCDate()
                    ));
                    
                    const now = new Date();
                    const nowDateUTC = new Date(Date.UTC(
                        now.getFullYear(), 
                        now.getMonth(), 
                        now.getDate()
                    ));
                    
                    const timeDiff = nowDateUTC.getTime() - pedidoDateUTC.getTime();
                    const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
                    
                    console.log('üìÖ Compara√ß√£o de datas (UTC):', {
                        pedidoOriginal: pedido.DATA_ENVIO1,
                        pedidoDateUTC: pedidoDateUTC.toISOString().split('T')[0],
                        nowDateUTC: nowDateUTC.toISOString().split('T')[0],
                        daysDiff: daysDiff,
                        isRecent: daysDiff <= 2
                    });
                    
                    // Pedidos de at√© 2 dias atr√°s
                    return daysDiff <= 2;
                });

                console.log('üïê Pedidos das √∫ltimas 48h:', recentPedidos.length);

                // NOVA L√ìGICA: Detectar PEDIDOS NOVOS por DATA/HORA (√∫ltimos 15 minutos)
                const now = new Date();
                const quinzeMinutosAtras = new Date(now.getTime() - (15 * 60 * 1000)); // 15 minutos atr√°s
                
                // Filtrar pedidos dos √öLTIMOS 15 MINUTOS (pedidos realmente novos)
                const pedidosNovissimos = pedidosNovos.filter(pedido => {
                    if (!pedido.DATA_ENVIO1) return false;
                    
                    const pedidoDate = new Date(pedido.DATA_ENVIO1);
                    const isRecent = pedidoDate >= quinzeMinutosAtras;
                    
                    console.log('‚è∞ Verificando se √© pedido nov√≠ssimo:', {
                        responsavel: pedido.RESPONSAVEL_PELO_CARTAO,
                        dataOriginal: pedido.DATA_ENVIO1,
                        dateParsed: pedidoDate.toLocaleString(),
                        quinzeMinutosAtras: quinzeMinutosAtras.toLocaleString(),
                        isRecent: isRecent,
                        minutosAtras: Math.round((now - pedidoDate) / (1000 * 60))
                    });
                    
                    return isRecent;
                });
                
                console.log('üÜï Pedidos dos √∫ltimos 15 minutos:', pedidosNovissimos.length);
                
                // CONTAGEM SIMPLES: Detectar se h√° mais pedidos que antes
                const currentCount = pedidosNovos.length;
                const currentCountNovissimos = pedidosNovissimos.length;
                
                console.log('üìä An√°lise de PEDIDOS NOVOS:', {
                    currentCount: currentCount,
                    lastPedidosCount: window.lastPedidosCount,
                    currentCountNovissimos: currentCountNovissimos,
                    countIncreased: currentCount > window.lastPedidosCount,
                    hasRecentOrders: currentCountNovissimos > 0
                });

                // Se √© a primeira verifica√ß√£o, salvar estado inicial
                if (window.lastPedidosCount === 0) {
                    window.lastPedidosCount = currentCount;
                    window.lastCheckTimestamp = Date.now();
                    console.log('‚è∞ Primeira verifica√ß√£o - salvando estado inicial:', {
                        count: currentCount,
                        timestamp: new Date(window.lastCheckTimestamp)
                    });
                    
                    // PRIMEIRA VEZ: N√£o notificar nada, apenas salvar estado
                    console.log('üîá Primeira verifica√ß√£o: n√£o enviando notifica√ß√µes, apenas salvando estado');
                    return;
                }

                // DETECTAR PEDIDOS NOVOS: Por contagem OU por pedidos recentes (15 min)
                let pedidosNovosDetectados = [];
                let motivoDeteccao = '';
                
                if (currentCount > window.lastPedidosCount) {
                    // M√âTODO 1: Mais pedidos que antes (NOVO PEDIDO CRIADO!)
                    motivoDeteccao = `PEDIDO NOVO DETECTADO! Contagem: ${window.lastPedidosCount} ‚Üí ${currentCount}`;
                    console.log(`üÜï ${motivoDeteccao}`);
                    
                    // Notificar os pedidos dos √∫ltimos 15 minutos
                    pedidosNovosDetectados = pedidosNovissimos;
                    
                } else if (currentCountNovissimos > 0 && currentCount === window.lastPedidosCount) {
                    // M√âTODO 2: H√° pedidos recentes (√∫ltimos 15 min) mesmo sem mudan√ßa de contagem
                    motivoDeteccao = `PEDIDOS RECENTES DETECTADOS (${currentCountNovissimos} pedidos dos √∫ltimos 15 min)`;
                    console.log(`‚è∞ ${motivoDeteccao}`);
                    
                    // Notificar os pedidos dos √∫ltimos 15 minutos
                    pedidosNovosDetectados = pedidosNovissimos;
                    
                } else {
                    // Nenhuma novidade detectada
                    motivoDeteccao = 'Nenhum pedido novo detectado';
                    console.log('‚úÖ Sem novidades');
                }
                
                console.log('üÜï Motivo da detec√ß√£o:', motivoDeteccao);
                console.log('üÜï Pedidos novos detectados:', pedidosNovosDetectados.length);

                // Agrupar por respons√°vel e enviar notifica√ß√µes (APENAS se h√° mudan√ßas recentes)
                
                if (currentCount > window.lastPedidosCount) {
                    // M√âTODO 1: Mais pedidos que antes
                    motivoDeteccao = `CONTAGEM AUMENTOU: ${window.lastPedidosCount} ‚Üí ${currentCount}`;
                    console.log(`üÜï ${motivoDeteccao}`);
                    
                    // Pegar TODOS os pedidos de hoje (incluindo os novos)
                    pedidosNovosDetectados = recentPedidos.filter(pedido => {
                        const pedidoDate = new Date(pedido.DATA_ENVIO1);
                        const pedidoDateUTC = new Date(Date.UTC(
                            pedidoDate.getUTCFullYear(), 
                            pedidoDate.getUTCMonth(), 
                            pedidoDate.getUTCDate()
                        ));
                        
                        const now = new Date();
                        const nowDateUTC = new Date(Date.UTC(
                            now.getFullYear(), 
                            now.getMonth(), 
                            now.getDate()
                        ));
                        
                        return pedidoDateUTC.getTime() === nowDateUTC.getTime();
                    });
                    
                } else {
                    // Nenhuma novidade detectada
                    motivoDeteccao = 'Nenhum pedido novo detectado';
                    console.log('‚úÖ Sem novidades');
                }
                
                console.log('üÜï Motivo da detec√ß√£o:', motivoDeteccao);
                console.log('üÜï Pedidos novos detectados:', pedidosNovosDetectados.length);

                // Agrupar por respons√°vel e enviar notifica√ß√µes (APENAS se h√° mudan√ßas recentes)
                    // M√âTODO 2: CR√çTICO - Hash mudou (APROVA√á√ïES/MODIFICA√á√ïES detectadas!)
                    motivoDeteccao = 'APROVA√á√ÉO DETECTADA - Hash mudou (pedidos foram aprovados)';
                    console.log(`üîÑ ${motivoDeteccao}`);
                    
                    // Comparar estado anterior vs atual para identificar NOVOS APROVADOS
                    try {
                        const estadoAnterior = lastPedidosHash ? JSON.parse(lastPedidosHash) : [];
                        const estadoAtual = JSON.parse(currentHash);
                        
                        console.log('ÔøΩ Analisando mudan√ßas de aprova√ß√£o:');
                        console.log('Estado anterior:', estadoAnterior.length, 'pedidos');
                        console.log('Estado atual:', estadoAtual.length, 'pedidos');
                        
                        // Identificar pedidos que foram aprovados agora
                        const novosAprovados = estadoAtual.filter(atual => {
                            const anterior = estadoAnterior.find(ant => 
                                ant.responsavel === atual.responsavel && 
                                ant.pagcorp === atual.pagcorp &&
                                ant.data === atual.data
                            );
                            
                            // Se n√£o existia antes OU mudou status de aprova√ß√£o
                            return !anterior || anterior.aprovado !== atual.aprovado;
                        });
                        
                        console.log('üÜï Novos pedidos aprovados detectados:', novosAprovados.length);
                        novosAprovados.forEach(pedido => {
                            console.log('‚úÖ Aprovado:', pedido.responsavel, '- R$', pedido.total);
                        });
                        
                    } catch (error) {
                        console.log('‚ö†Ô∏è Erro ao comparar estados:', error);
                    }
                    
                    // C√≥digo removido - estava duplicado e mal formatado
                
                // Agrupar por respons√°vel e enviar notifica√ß√µes (APENAS se h√° mudan√ßas recentes)
                if (pedidosNovosDetectados.length > 0) {
                    const grupos = {};
                    pedidosNovosDetectados.forEach(pedido => {
                        const responsavel = pedido.RESPONSAVEL_PELO_CARTAO || 'Respons√°vel n√£o informado';
                        if (!grupos[responsavel]) {
                            grupos[responsavel] = {
                                responsavel,
                                total: 0,
                                quantidade: 0
                            };
                        }
                        grupos[responsavel].total += parseFloat(pedido.TOTAL_PAGAR) || 0;
                        grupos[responsavel].quantidade++;
                    });

                    console.log('üë• Grupos para notifica√ß√£o:', grupos);
                    console.log('üì¢ Motivo:', motivoDeteccao);

                    // FILTRO ANTI-SPAM: S√≥ notificar se n√£o foi a primeira verifica√ß√£o OU se realmente h√° mudan√ßas
                    const isFirstCheck = window.lastCheckTimestamp === null;
                    const timeSinceLastCheck = Date.now() - (window.lastCheckTimestamp || 0);
                    
                    if (!isFirstCheck || timeSinceLastCheck > 15000) { // 15 segundos de cooldown
                        // Enviar notifica√ß√£o para cada respons√°vel
                        Object.values(grupos).forEach(grupo => {
                            console.log('üîî Enviando notifica√ß√£o para:', grupo);
                            sendPushNotification(grupo);
                        });
                        
                        showNotification(`üîî ${Object.keys(grupos).length} notifica√ß√µes enviadas! (${motivoDeteccao})`, 'success');
                    } else {
                        console.log('‚è∏Ô∏è Notifica√ß√µes suprimidas (muito recente ou primeira verifica√ß√£o)');
                    }
                } else {
                    console.log('‚úÖ Nenhuma mudan√ßa detectada - sem notifica√ß√µes');
                }

                // Atualizar estado para pr√≥xima verifica√ß√£o
                window.lastPedidosCount = currentCount;
                window.lastCheckTimestamp = Date.now();
                console.log('‚è∞ Estado atualizado:', {
                    count: currentCount,
                    timestamp: new Date(window.lastCheckTimestamp)
                });

            } catch (error) {
                console.error('‚ùå Erro ao verificar novos pedidos:', error);
            }
        }
        
        function sendPushNotification(grupo) {
            const { responsavel, total, quantidade } = grupo;
            
            const titulo = `üí≥ Novo Pedido PAGCORP`;
            const quantidadeText = quantidade > 1 ? `${quantidade} pedidos` : 'pedido';
            const mensagem = `Ol√°, ${responsavel} solicitou R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${quantidadeText}) e j√° foi aprovado.`;
            
            // Criar notifica√ß√£o do navegador
            if (window.notificationPermission) {
                const notification = new Notification(titulo, {
                    body: mensagem,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%232563eb"/><text x="50" y="60" font-family="Arial,sans-serif" font-size="35" fill="white" text-anchor="middle" font-weight="bold">üí≥</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%232563eb"/><text x="50" y="60" font-family="Arial,sans-serif" font-size="35" fill="white" text-anchor="middle" font-weight="bold">üí≥</text></svg>',
                    tag: `pedido-${responsavel}`,
                    requireInteraction: true,
                    timestamp: Date.now()
                });
                
                // Auto-fechar ap√≥s 10 segundos
                setTimeout(() => {
                    notification.close();
                }, 10000);
                
                // Click para abrir a aplica√ß√£o
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
            }
            
            // Tamb√©m mostrar notifica√ß√£o interna
            showNotification(mensagem, 'info');
            
            console.log(`üîî Push enviado: ${mensagem}`);
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .header h1 .logo {
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #2563eb;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .header-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .filters-section {
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .date-filter {
            margin-bottom: 1rem;
        }

        .date-filter label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .date-inputs input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .status-filters {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .status-btn {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            font-size: 0.8rem;
        }

        .status-btn.active {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .status-btn:hover:not(.active) {
            border-color: #94a3b8;
            background: #f1f5f9;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .bulk-actions input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #2563eb;
        }

        .bulk-actions button {
            padding: 0.5rem 1rem;
            background: #059669;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .bulk-actions button:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        .bulk-actions button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            padding: 1rem;
            background: #f8fafc;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .payments-container {
            padding: 1rem;
            max-height: 50vh;
            overflow-y: auto;
        }

        .payment-card {
            background: white;
            border-radius: 16px;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .payment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .payment-header {
            padding: 1rem;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .payment-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #2563eb;
        }

        .payment-main-content {
            flex: 1;
        }



        .payment-main-info {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .payment-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .payment-subtitle {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .payment-amount {
            text-align: right;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .amount-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #059669;
        }

        .deposit-btn {
            width: 40px;
            height: 40px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .deposit-btn:hover {
            background: #047857;
            transform: scale(1.1);
        }

        .deposit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .deposited-badge {
            background: #10b981;
            color: white;
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            border: none;
            min-width: 40px;
            height: 40px;
            justify-content: center;
        }

        .payment-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .payment-card.expanded .payment-details {
            max-height: 300px;
        }

        .payment-details-content {
            padding: 0 1rem 1rem;
            border-top: 1px solid #f3f4f6;
            margin-top: 1rem;
            padding-top: 1rem;
            max-height: 250px;
            overflow-y: auto;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            padding: 0.2rem 0;
            font-size: 0.85rem;
        }

        .detail-label {
            font-weight: 500;
            color: #6b7280;
            min-width: 100px;
        }

        .detail-value {
            font-weight: 600;
            color: #1f2937;
            text-align: right;
            flex: 1;
            margin-left: 0.5rem;
        }

        .pedido-individual {
            border: 1px solid #f0f0f0;
            padding: 0.4rem;
            margin: 0.3rem 0;
            border-radius: 6px;
            background: #fafafa;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .app-container {
                max-width: 420px;
                margin: 0 auto;
                border-radius: 20px;
                overflow: hidden;
                margin-top: 2rem;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>
                <span class="logo">üí≥</span>
                DEP√ìSITO DE SALDO PAGCORP
            </h1>
            <div class="header-actions">
                <button class="header-btn" onclick="toggleMonitoring()" id="monitoringBtn">üîî Ativando...</button>
                <button class="header-btn" onclick="forceCheck()">üîÑ Verificar Agora</button>
                <button class="header-btn" onclick="forceReset()">üÜï Reset & Verificar</button>
                <button class="header-btn" onclick="testPushNotification()">üß™ Teste Push</button>
                <button class="header-btn" onclick="atualizarDados()">Atualizar</button>
            </div>
        </header>

        <section class="filters-section">
            <div class="date-filter">
                <label>Filtrar por Data de Envio</label>
                <div class="date-inputs">
                    <input type="date" id="dataInicio" onchange="aplicarFiltros()">
                    <input type="date" id="dataFim" onchange="aplicarFiltros()">
                </div>
            </div>

            <div class="status-filters">
                <button class="status-btn active" data-status="todos" onclick="filtrarPorStatus('todos')">Todos</button>
                <button class="status-btn" data-status="pendente" onclick="filtrarPorStatus('pendente')">Pendente</button>
                <button class="status-btn" data-status="aprovado" onclick="filtrarPorStatus('aprovado')">Aprovado</button>
                <button class="status-btn" data-status="depositado" onclick="filtrarPorStatus('depositado')">Depositado</button>
            </div>

            <div class="bulk-actions">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                <label for="selectAll">Selecionar Todos</label>
                <button onclick="depositarSelecionados()" id="bulkDepositBtn" disabled>Depositar Selecionados</button>
            </div>
        </section>

        <section class="summary-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total de Pedidos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="selectedCount">0</div>
                <div class="stat-label">Total Selecionados</div>
            </div>
        </section>

        <section class="payments-container" id="paymentsContainer">
            <div class="loading">
                <p>Clique em "Atualizar" para carregar os dados</p>
            </div>
        </section>
    </div>

    <script>
        let dadosReais = [];
        let dadosFiltrados = [];
        let filtroAtivo = 'todos';

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina carregada, iniciando configura√ß√µes...');
            
            // Definir data de hoje nos filtros
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataInicio').value = hoje;
            document.getElementById('dataFim').value = hoje;
            
            mostrarMensagemInicial();
            
            console.log('üîî Configurando timers para ativa√ß√£o autom√°tica...');
            
            // Timer 1: Tentar ativar ap√≥s 3 segundos
            setTimeout(() => {
                console.log('‚è∞ Timer 3s - Estado:', {
                    notificationPermission: window.notificationPermission,
                    monitoringActive: window.monitoringActive
                });
                
                if (window.notificationPermission && !window.monitoringActive) {
                    console.log('üîî Ativando monitoramento (timer 3s)');
                    toggleMonitoring();
                }
            }, 3000);
            
            // Timer 2: Tentar ativar ap√≥s 5 segundos (backup)
            setTimeout(() => {
                console.log('‚è∞ Timer 5s (backup) - Estado:', {
                    notificationPermission: window.notificationPermission,
                    monitoringActive: window.monitoringActive
                });
                
                if (window.notificationPermission && !window.monitoringActive) {
                    console.log('üîî Ativando monitoramento (timer 5s backup)');
                    toggleMonitoring();
                }
            }, 5000);
            
            // Timer 3: Verifica√ß√£o peri√≥dica se monitoramento parou
            setInterval(() => {
                if (window.notificationPermission && !window.monitoringActive) {
                    console.log('‚ö†Ô∏è Monitoramento deveria estar ativo mas n√£o est√°. Reativando...');
                    toggleMonitoring();
                }
            }, 30000); // Verifica a cada 30 segundos
            
            console.log('‚úÖ Configura√ß√£o de timers conclu√≠da');
        });

        function toggleMonitoring() {
            const btn = document.getElementById('monitoringBtn');
            
            console.log('üîî toggleMonitoring chamado. Estado atual:', {
                monitoringActive: window.monitoringActive,
                notificationPermission: window.notificationPermission,
                monitoringInterval: window.monitoringInterval
            });
            
            if (!window.monitoringActive) {
                if (!window.notificationPermission) {
                    console.log('‚ùå Permiss√£o de notifica√ß√£o necess√°ria!');
                    showNotification('‚ùå Permiss√£o de notifica√ß√£o necess√°ria!', 'error');
                    requestNotificationPermission();
                    return;
                }
                
                console.log('üîî Ativando monitoramento...');
                startPedidosMonitoring();
                window.monitoringActive = true;
                btn.textContent = 'üîî Push ON';
                btn.style.background = 'rgba(16, 185, 129, 0.3)';
                btn.style.color = 'white';
                showNotification('üîî Monitoramento AUTOM√ÅTICO ativado! Verificando a cada 10s', 'success');
                console.log('‚úÖ Monitoramento ativado com sucesso');
            } else {
                console.log('üîî Desativando monitoramento...');
                stopPedidosMonitoring();
                window.monitoringActive = false;
                btn.textContent = 'üîî Push OFF';
                btn.style.background = 'rgba(255,255,255,0.2)';
                btn.style.color = 'white';
                showNotification('üîî Monitoramento autom√°tico desativado', 'info');
                console.log('‚úÖ Monitoramento desativado');
            }
        }
        
        function forceCheck() {
            if (!window.notificationPermission) {
                showNotification('‚ùå Permiss√£o de notifica√ß√£o necess√°ria!', 'error');
                return;
            }
            
            console.log('üîÑ Verifica√ß√£o MANUAL iniciada...');
            showNotification('üîÑ Verificando pedidos manualmente...', 'info');
            
            // N√ÉO resetar estado - deixar o sistema detectar mudan√ßas naturalmente
            console.log('üîÑ Verifica√ß√£o manual SEM reset - para detectar mudan√ßas reais');
            
            checkForNewPedidos().then(() => {
                console.log('‚úÖ Verifica√ß√£o manual conclu√≠da');
                showNotification('‚úÖ Verifica√ß√£o manual conclu√≠da!', 'success');
            });
        }
        
        function forceReset() {
            if (!window.notificationPermission) {
                showNotification('‚ùå Permiss√£o de notifica√ß√£o necess√°ria!', 'error');
                return;
            }
            
            console.log('üÜï RESET FOR√áADO iniciado...');
            showNotification('üÜï Resetando estado e verificando...', 'info');
            
            // Resetar estado para for√ßar detec√ß√£o completa
            const oldState = {
                lastPedidosCount: window.lastPedidosCount,
                lastPedidosHash: window.lastPedidosHash,
                lastCheckTimestamp: window.lastCheckTimestamp
            };
            
            window.lastPedidosCount = 0;
            window.lastPedidosHash = '';
            window.lastCheckTimestamp = null;
            
            console.log('üîÑ Estado resetado FOR√áADAMENTE:', {
                oldState: oldState,
                newState: { 
                    lastPedidosCount: window.lastPedidosCount, 
                    lastPedidosHash: window.lastPedidosHash, 
                    lastCheckTimestamp: window.lastCheckTimestamp 
                }
            });
            
            checkForNewPedidos().then(() => {
                console.log('‚úÖ Reset e verifica√ß√£o conclu√≠dos');
                showNotification('‚úÖ Reset completo! Todas as notifica√ß√µes enviadas.', 'success');
            });
        }
        
        function testPushNotification() {
            if (!window.notificationPermission) {
                showNotification('‚ùå Permiss√£o de notifica√ß√£o necess√°ria!', 'error');
                requestNotificationPermission();
                return;
            }
            
            // Se h√° dados carregados, usar dados reais
            if (dadosFiltrados && dadosFiltrados.length > 0) {
                checkForNewPedidosManual();
            } else {
                // Sen√£o, enviar push de teste
                const testGroup = {
                    responsavel: 'RONALDO APARECIDO DE BARROS',
                    total: 1380.00,
                    quantidade: 1
                };
                
                sendPushNotification(testGroup);
                showNotification('üß™ Push de teste enviado!', 'success');
            }
        }
        
        async function checkForNewPedidosManual() {
            if (!window.notificationPermission) return;
            
            try {
                const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:5000/api/pedidos'
                    : '/api/pedidos';
                
                const response = await fetch(apiUrl);
                if (!response.ok) return;
                
                const resultado = await response.json();
                if (!resultado.success || !resultado.data) return;
                
                // Filtrar TODOS os pedidos aprovados sem fechamento
                const pedidosAprovados = resultado.data.filter(pedido => 
                    pedido.FECHAMENTO !== 'SIM' && 
                    pedido.FECHAMENTO !== 'Sim' && 
                    pedido.FECHAMENTO !== 'sim' &&
                    pedido.APROVADO_POR && 
                    pedido.APROVADO_POR.trim() !== '' &&
                    pedido.DEPOSITADO !== 'DEPOSITADO'
                );
                
                // Agrupar por respons√°vel
                const grupos = {};
                pedidosAprovados.forEach(pedido => {
                    const responsavel = pedido.RESPONSAVEL_PELO_CARTAO || 'Respons√°vel n√£o informado';
                    if (!grupos[responsavel]) {
                        grupos[responsavel] = {
                            responsavel,
                            total: 0,
                            quantidade: 0
                        };
                    }
                    grupos[responsavel].total += parseFloat(pedido.TOTAL_PAGAR) || 0;
                    grupos[responsavel].quantidade++;
                });
                
                // Enviar uma notifica√ß√£o para cada grupo
                Object.values(grupos).slice(0, 3).forEach(grupo => { // M√°ximo 3 para n√£o spammar
                    setTimeout(() => {
                        sendPushNotification(grupo);
                    }, Math.random() * 2000); // Delay aleat√≥rio
                });
                
                showNotification(`üì± ${Object.keys(grupos).length} notifica√ß√µes enviadas!`, 'success');
                
            } catch (error) {
                console.error('Erro ao verificar pedidos:', error);
                showNotification('‚ùå Erro ao buscar pedidos', 'error');
            }
        }

        function mostrarMensagemInicial() {
            const container = document.getElementById('paymentsContainer');
            container.innerHTML = `
                <div class="loading">
                    <p>Clique em "Atualizar" para carregar os dados</p>
                </div>
            `;
        }

        async function atualizarDados() {
            try {
                showNotification('Conectando ao Azure SQL Server...', 'info');
                
                const container = document.getElementById('paymentsContainer');
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Conectando ao banco de dados...</p>
                    </div>
                `;

                // Detectar URL da API automaticamente
                const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:5000/api/pedidos'
                    : '/api/pedidos';

                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const resultado = await response.json();

                if (resultado.success && resultado.data) {
                    // Filtrar dados onde FECHAMENTO != 'SIM'
                    dadosReais = resultado.data.filter(pedido => 
                        pedido.FECHAMENTO !== 'SIM' && pedido.FECHAMENTO !== 'Sim' && pedido.FECHAMENTO !== 'sim'
                    );
                    
                    aplicarFiltros();
                    showNotification(`${dadosReais.length} pedidos carregados com sucesso!`, 'success');
                } else {
                    throw new Error(resultado.error || 'Erro desconhecido');
                }

            } catch (error) {
                console.error('Erro:', error);
                
                const container = document.getElementById('paymentsContainer');
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Erro de Conex√£o</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                
                showNotification(`Erro: ${error.message}`, 'error');
            }
        }

        function agruparPorDiaEResponsavel(dados) {
            const grupos = {};
            
            dados.forEach((pedido, indexOriginal) => {
                const dataEnvio = pedido.DATA_ENVIO1 ? new Date(pedido.DATA_ENVIO1).toDateString() : 'Sem data';
                const responsavelCartao = pedido.RESPONSAVEL_PELO_CARTAO || 'Sem respons√°vel'; // CORRIGIDO: usar RESPONSAVEL_PELO_CARTAO
                const chave = `${dataEnvio}_${responsavelCartao}`;
                
                if (!grupos[chave]) {
                    grupos[chave] = {
                        responsavel: responsavelCartao, // CORRIGIDO: usar responsavelCartao
                        dataEnvio: dataEnvio,
                        pedidos: [],
                        totalValue: 0,
                        firstPedido: pedido
                    };
                }
                
                grupos[chave].pedidos.push({...pedido, indexOriginal});
                grupos[chave].totalValue += parseFloat(pedido.TOTAL_PAGAR) || 0;
            });
            
            return Object.values(grupos);
        }

        function aplicarFiltros() {
            let dados = [...dadosReais];

            // Filtro por data
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            if (dataInicio || dataFim) {
                dados = dados.filter(pedido => {
                    if (!pedido.DATA_ENVIO1) return false;
                    
                    const dataEnvio = new Date(pedido.DATA_ENVIO1);
                    const inicio = dataInicio ? new Date(dataInicio) : null;
                    const fim = dataFim ? new Date(dataFim) : null;

                    if (inicio && dataEnvio < inicio) return false;
                    if (fim && dataEnvio > fim) return false;
                    return true;
                });
            }

            // Filtro por status
            if (filtroAtivo !== 'todos') {
                dados = dados.filter(pedido => {
                    switch (filtroAtivo) {
                        case 'pendente':
                            return !pedido.APROVADO_POR || pedido.APROVADO_POR.trim() === '';
                        case 'aprovado':
                            return pedido.APROVADO_POR && pedido.APROVADO_POR.trim() !== '' && pedido.DEPOSITADO !== 'DEPOSITADO';
                        case 'depositado':
                            return pedido.DEPOSITADO === 'DEPOSITADO';
                        default:
                            return true;
                    }
                });
            }

            dadosFiltrados = dados;
            renderizarPedidos();
            atualizarEstatisticas();
        }

        function filtrarPorStatus(status) {
            filtroAtivo = status;
            
            // Atualizar bot√µes
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            aplicarFiltros();
        }

        function renderizarPedidos() {
            const container = document.getElementById('paymentsContainer');
            
            if (!dadosFiltrados || dadosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Nenhum pedido encontrado</h3>
                        <p>Verifique os filtros aplicados</p>
                    </div>
                `;
                return;
            }

            // Agrupar dados
            const gruposAgrupados = agruparPorDiaEResponsavel(dadosFiltrados);

            const html = gruposAgrupados.map((grupo, groupIndex) => {
                const responsavel = grupo.responsavel;
                const pagcgorp = grupo.firstPedido.PAGCORP || grupo.firstPedido.PAGCGORP || 'Sem c√≥digo';
                const totalValue = grupo.totalValue;
                const quantidadePedidos = grupo.pedidos.length;
                const isDepositado = grupo.pedidos.every(p => p.DEPOSITADO === 'DEPOSITADO');

                const detalhesHtml = grupo.pedidos.map(pedido => {
                    const valorIndividual = parseFloat(pedido.TOTAL_PAGAR) || 0;
                    const dataEnvio = pedido.DATA_ENVIO1 ? new Date(pedido.DATA_ENVIO1).toLocaleDateString('pt-BR') : 'N/A';
                    const projeto = pedido.PROJETO || 'N/A';
                    const responsavelCartao = pedido.RESPONSAVEL_PELO_CARTAO || 'N/A'; // CORRIGIDO: usar RESPONSAVEL_PELO_CARTAO
                    const tipoRefeicao = pedido.TIPO_REFEICAO || 'N/A';

                    return `
                        <div class="pedido-individual">
                            <div class="detail-row">
                                <span class="detail-label">Valor:</span>
                                <span class="detail-value">R$ ${valorIndividual.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Data:</span>
                                <span class="detail-value">${dataEnvio}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Projeto:</span>
                                <span class="detail-value">${projeto}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Respons√°vel:</span>
                                <span class="detail-value">${responsavelCartao}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Refei√ß√£o:</span>
                                <span class="detail-value">${tipoRefeicao}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                const quantidadeText = quantidadePedidos > 1 ? `<div style="font-size: 0.8rem; color: #666;">${quantidadePedidos} pedidos do dia</div>` : '';

                return `
                    <div class="payment-card" data-group-id="${groupIndex}">
                        <div class="payment-header" onclick="togglePaymentDetails(${groupIndex})">
                            <input type="checkbox" class="payment-checkbox" data-group-index="${groupIndex}" onchange="updateBulkActions()" onclick="event.stopPropagation()">
                            <div class="payment-main-content">
                                <div class="payment-main-info">
                                    <div>
                                        <div class="payment-title">${responsavel}</div>
                                        <div class="payment-subtitle">${pagcgorp}</div>
                                        ${quantidadeText}
                                    </div>
                                    <div class="payment-amount">
                                        <div class="amount-value">R$ ${totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                        ${isDepositado ? 
                                            '<span class="deposited-badge">‚úì DEPOSITADO</span>' : 
                                            `<button class="deposit-btn" onclick="depositarGrupo(${groupIndex})" title="Depositar">$</button>`
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="payment-details">
                            <div class="payment-details-content">
                                ${detalhesHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function togglePaymentDetails(index) {
            const cards = document.querySelectorAll('.payment-card');
            if (cards[index]) {
                cards[index].classList.toggle('expanded');
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.payment-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkActions();
        }

        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
            const bulkBtn = document.getElementById('bulkDepositBtn');
            const selectAll = document.getElementById('selectAll');
            
            bulkBtn.disabled = checkboxes.length === 0;
            
            const totalCheckboxes = document.querySelectorAll('.payment-checkbox').length;
            selectAll.checked = checkboxes.length === totalCheckboxes && totalCheckboxes > 0;
            
            // Atualizar contador de selecionados
            document.getElementById('selectedCount').textContent = checkboxes.length;
        }

        async function depositarGrupo(groupIndex) {
            try {
                const grupos = agruparPorDiaEResponsavel(dadosFiltrados);
                const grupo = grupos[groupIndex];
                
                // Preparar dados para envio
                const pedidosParaDepositar = grupo.pedidos.map(pedido => ({
                    RESPONSAVEL_PELO_CARTAO: pedido.RESPONSAVEL_PELO_CARTAO,
                    PAGCORP: pedido.PAGCORP,
                    TOTAL_PAGAR: pedido.TOTAL_PAGAR
                }));
                
                // Fazer requisi√ß√£o para o servidor
                const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:5000/api/pedidos/depositar'
                    : '/api/pedidos/depositar';
                
                showNotification('Enviando para o servidor...', 'info');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pedidos: pedidosParaDepositar
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Servidor offline ou erro HTTP: ${response.status}`);
                }
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    showNotification(`${resultado.pedidos_atualizados} pedido(s) depositado(s) no banco!`, 'success');
                    
                    // Recarregar dados do servidor para atualizar a interface
                    await atualizarDados();
                } else {
                    throw new Error(resultado.error || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('Erro ao depositar grupo:', error);
                
                // Fallback: simular dep√≥sito localmente se servidor falhar
                const grupos = agruparPorDiaEResponsavel(dadosFiltrados);
                const grupo = grupos[groupIndex];
                
                grupo.pedidos.forEach(pedido => {
                    const indexOriginal = dadosFiltrados.findIndex(p => p === pedido);
                    if (indexOriginal !== -1) {
                        dadosFiltrados[indexOriginal].DEPOSITADO = 'DEPOSITADO';
                    }
                    
                    const indexReal = dadosReais.findIndex(p => 
                        p.RESPONSAVEL_PELO_CARTAO === pedido.RESPONSAVEL_PELO_CARTAO && 
                        p.DATA_ENVIO1 === pedido.DATA_ENVIO1
                    );
                    if (indexReal !== -1) {
                        dadosReais[indexReal].DEPOSITADO = 'DEPOSITADO';
                    }
                });
                
                showNotification(`${grupo.pedidos.length} pedido(s) marcado(s) localmente (servidor offline)`, 'success');
                aplicarFiltros();
            }
        }

        async function depositarSelecionados() {
            try {
                const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
                const grupos = agruparPorDiaEResponsavel(dadosFiltrados);
                
                let todosPedidosParaDepositar = [];
                
                checkboxes.forEach(checkbox => {
                    const groupIndex = parseInt(checkbox.dataset.groupIndex);
                    const grupo = grupos[groupIndex];
                    
                    if (grupo) {
                        grupo.pedidos.forEach(pedido => {
                            todosPedidosParaDepositar.push({
                                RESPONSAVEL_PELO_CARTAO: pedido.RESPONSAVEL_PELO_CARTAO,
                                PAGCORP: pedido.PAGCORP,
                                TOTAL_PAGAR: pedido.TOTAL_PAGAR
                            });
                        });
                    }
                });
                
                if (todosPedidosParaDepositar.length === 0) {
                    showNotification('Nenhum pedido selecionado para depositar', 'error');
                    return;
                }
                
                // Fazer requisi√ß√£o para o servidor
                const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:5000/api/pedidos/depositar'
                    : '/api/pedidos/depositar';
                
                showNotification('Enviando para o servidor...', 'info');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pedidos: todosPedidosParaDepositar
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Servidor offline ou erro HTTP: ${response.status}`);
                }
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    showNotification(`${resultado.pedidos_atualizados} pedido(s) depositado(s) no banco!`, 'success');
                    
                    document.getElementById('selectAll').checked = false;
                    updateBulkActions();
                    
                    // Recarregar dados do servidor para atualizar a interface
                    await atualizarDados();
                } else {
                    throw new Error(resultado.error || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('Erro ao depositar selecionados:', error);
                
                // Fallback: simular dep√≥sito localmente se servidor falhar
                const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
                const grupos = agruparPorDiaEResponsavel(dadosFiltrados);
                let totalPedidos = 0;
                
                checkboxes.forEach(checkbox => {
                    const groupIndex = parseInt(checkbox.dataset.groupIndex);
                    const grupo = grupos[groupIndex];
                    
                    if (grupo) {
                        grupo.pedidos.forEach(pedido => {
                            const indexFiltrado = dadosFiltrados.findIndex(p => p === pedido);
                            if (indexFiltrado !== -1) {
                                dadosFiltrados[indexFiltrado].DEPOSITADO = 'DEPOSITADO';
                            }
                            
                            const indexReal = dadosReais.findIndex(p => 
                                p.RESPONSAVEL_PELO_CARTAO === pedido.RESPONSAVEL_PELO_CARTAO && 
                                p.DATA_ENVIO1 === pedido.DATA_ENVIO1
                            );
                            if (indexReal !== -1) {
                                dadosReais[indexReal].DEPOSITADO = 'DEPOSITADO';
                            }
                        });
                        totalPedidos += grupo.pedidos.length;
                    }
                });
                
                showNotification(`${totalPedidos} pedido(s) marcado(s) localmente (servidor offline)`, 'success');
                
                document.getElementById('selectAll').checked = false;
                updateBulkActions();
                aplicarFiltros();
            }
        }

        async function atualizarDepositado(pedido, index) {
            // Simular atualiza√ß√£o no banco - aqui voc√™ implementaria a API PUT/PATCH
            console.log('Atualizando depositado para:', pedido);
            
            // Atualizar localmente
            dadosFiltrados[index].DEPOSITADO = 'DEPOSITADO';
            
            // Rerender
            renderizarPedidos();
            atualizarEstatisticas();
        }

        function atualizarEstatisticas() {
            const totalCount = dadosFiltrados.length;
            document.getElementById('totalCount').textContent = totalCount;
            
            // Atualizar contador de selecionados
            const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
            document.getElementById('selectedCount').textContent = checkboxes.length;
        }

        function limparCache() {
            dadosReais = [];
            dadosFiltrados = [];
            filtroAtivo = 'todos';
            
            // Reset filtros
            document.getElementById('dataInicio').value = '';
            document.getElementById('dataFim').value = '';
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-status="todos"]').classList.add('active');
            
            // Reset sele√ß√µes
            document.getElementById('selectAll').checked = false;
            
            // Reset estat√≠sticas
            document.getElementById('totalCount').textContent = '0';
            document.getElementById('selectedCount').textContent = '0';
            
            mostrarMensagemInicial();
            showNotification('Cache limpo!', 'success');
        }

        function showNotification(message, type = 'info') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                left: '50%',
                transform: 'translateX(-50%)',
                backgroundColor: type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6',
                color: 'white',
                padding: '1rem 1.5rem',
                borderRadius: '12px',
                boxShadow: '0 10px 25px rgba(0,0,0,0.2)',
                zIndex: '9999',
                fontSize: '0.9rem',
                fontWeight: '500',
                maxWidth: '90vw',
                textAlign: 'center',
                animation: 'slideDown 0.3s ease-out'
            });

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease-out';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>