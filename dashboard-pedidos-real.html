<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PAGCORP - Dep√≥sito de Saldo</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Sistema de dep√≥sitos e pagamentos PAGCORP">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icon-192x192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .header h1 .logo {
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #2563eb;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .header-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .filters-section {
            padding: 1rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .date-filter {
            margin-bottom: 1rem;
        }

        .date-filter label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .date-inputs input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .status-filters {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .status-btn {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            font-size: 0.8rem;
        }

        .status-btn.active {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .bulk-actions input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #2563eb;
        }

        .bulk-actions button {
            padding: 0.5rem 1rem;
            background: #059669;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .bulk-actions button:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        .bulk-actions button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .payments-container {
            padding: 1rem;
            max-height: 75vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .payments-container::-webkit-scrollbar {
            width: 8px;
        }

        .payments-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .payments-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .payment-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .payment-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .payment-header {
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .payment-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #2563eb;
            margin-top: 0.125rem;
        }

        .payment-main-content {
            flex: 1;
        }

        .payment-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .payment-main-info {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.5rem;
            align-items: center;
        }

        .payment-subtitle {
            font-size: 0.95rem;
            font-weight: 700;
            color: #1f2937;
        }

        .payment-amount {
            text-align: right;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .amount-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: #059669;
        }

        .deposit-btn {
            width: 32px;
            height: 32px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .deposit-btn:hover {
            background: #047857;
            transform: scale(1.1);
        }

        .deposited-badge {
            background: #10b981;
            color: white;
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .payment-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .payment-card.expanded .payment-details {
            max-height: 1000px;
        }

        .payment-details-content {
            padding: 0 1rem 1rem;
            border-top: 1px solid #f3f4f6;
            margin-top: 1rem;
            padding-top: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            padding: 0.2rem 0;
            font-size: 0.85rem;
        }

        .detail-label {
            font-weight: 500;
            color: #6b7280;
        }

        .detail-value {
            font-weight: 600;
            color: #1f2937;
            text-align: right;
            flex: 1;
            margin-left: 0.5rem;
        }

        .pedido-individual {
            border: 1px solid #f0f0f0;
            padding: 0.4rem;
            margin: 0.3rem 0;
            border-radius: 6px;
            background: #fafafa;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .payments-container {
                max-height: 70vh;
                padding: 0.5rem;
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 420px;
                margin: 2rem auto;
                border-radius: 20px;
                overflow: hidden;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>
                <span class="logo">üí≥</span>
                DEP√ìSITO DE SALDO PAGCORP
            </h1>
            <div class="header-actions">
                <button class="header-btn" onclick="toggleMonitoring()" id="monitoringBtn">üîî Push OFF</button>
                <button class="header-btn" onclick="atualizarDados()">üîÑ Atualizar</button>
            </div>
        </header>

        <section class="filters-section">
            <div class="date-filter">
                <label>Filtrar por Data de Envio</label>
                <div class="date-inputs">
                    <input type="date" id="dataInicio" onchange="aplicarFiltros()">
                    <input type="date" id="dataFim" onchange="aplicarFiltros()">
                </div>
            </div>

            <div class="status-filters">
                <button class="status-btn active" data-status="todos" onclick="filtrarPorStatus('todos')">Todos</button>
                <button class="status-btn" data-status="pendente" onclick="filtrarPorStatus('pendente')">Pendente</button>
                <button class="status-btn" data-status="aprovado" onclick="filtrarPorStatus('aprovado')">Aprovado</button>
                <button class="status-btn" data-status="depositado" onclick="filtrarPorStatus('depositado')">Depositado</button>
            </div>

            <div class="bulk-actions">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                <label for="selectAll">Selecionar Todos</label>
                <button onclick="depositarSelecionados()" id="bulkDepositBtn" disabled>üí∞ Depositar</button>
            </div>
        </section>

        <section class="payments-container" id="paymentsContainer">
            <div class="loading">
                <p>Clique em "üîÑ Atualizar" para carregar os dados</p>
            </div>
        </section>
    </div>

    <script>
        // ========== CONFIGURA√á√ïES GLOBAIS ==========
        const CONFIG = {
            API_URL: (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                ? 'http://localhost:5000/api'
                : '/api',
            MONITORING_INTERVAL: 10000, // 10 segundos
            NOTIFICATION_COOLDOWN: 15000, // 15 segundos
            RECENT_PEDIDOS_MINUTES: 15 // Pedidos dos √∫ltimos 15 minutos
        };

        // ========== ESTADO GLOBAL ==========
        const STATE = {
            dadosReais: [],
            dadosFiltrados: [],
            filtroAtivo: 'todos',
            monitoringActive: false,
            monitoringInterval: null,
            notificationPermission: false,
            lastCheckTimestamp: null,
            lastPedidosCount: 0
        };

        // ========== SERVICE WORKER E PWA ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('‚úÖ Service Worker registrado:', reg.scope))
                    .catch(err => console.log('‚ùå Service Worker falhou:', err));
            });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showNotification('üì± App pode ser instalado!', 'success');
        });

        // ========== NOTIFICA√á√ïES ==========
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                STATE.notificationPermission = permission === 'granted';
                
                if (STATE.notificationPermission) {
                    showNotification('‚úÖ Notifica√ß√µes ativadas!', 'success');
                    setTimeout(() => !STATE.monitoringActive && toggleMonitoring(), 2000);
                }
            }
        }

        function sendPushNotification(grupo) {
            const { responsavel, total, quantidade } = grupo;
            const titulo = `üí≥ Novo Pedido PAGCORP`;
            const mensagem = `${responsavel} solicitou R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${quantidade} pedido${quantidade > 1 ? 's' : ''})`;
            
            if (STATE.notificationPermission) {
                const notification = new Notification(titulo, {
                    body: mensagem,
                    icon: './icon-192x192.png',
                    tag: `pedido-${responsavel}`,
                    requireInteraction: true
                });
                
                setTimeout(() => notification.close(), 15000);
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
            
            showNotification(mensagem, 'info');
        }

        // ========== MONITORAMENTO ==========
        function toggleMonitoring() {
            const btn = document.getElementById('monitoringBtn');
            
            if (!STATE.monitoringActive) {
                if (!STATE.notificationPermission) {
                    requestNotificationPermission();
                    return;
                }
                
                STATE.monitoringInterval = setInterval(checkForNewPedidos, CONFIG.MONITORING_INTERVAL);
                STATE.monitoringActive = true;
                btn.textContent = 'üîî Push ON';
                btn.style.background = 'rgba(16, 185, 129, 0.3)';
                showNotification('üîî Monitoramento ativado!', 'success');
            } else {
                clearInterval(STATE.monitoringInterval);
                STATE.monitoringActive = false;
                btn.textContent = 'üîî Push OFF';
                btn.style.background = 'rgba(255,255,255,0.2)';
                showNotification('üîî Monitoramento desativado', 'info');
            }
        }

        async function checkForNewPedidos() {
            if (!STATE.notificationPermission) return;
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/pedidos`);
                if (!response.ok) return;
                
                const resultado = await response.json();
                if (!resultado.success) return;
                
                const pedidosNovos = resultado.data.filter(p => 
                    p.FECHAMENTO !== 'SIM' && 
                    p.APROVADO_POR && 
                    p.APROVADO_POR.trim() !== '' &&
                    p.DEPOSITADO !== 'DEPOSITADO'
                );
                
                const currentCount = pedidosNovos.length;
                
                // Primeira verifica√ß√£o - apenas salvar estado
                if (STATE.lastPedidosCount === 0) {
                    STATE.lastPedidosCount = currentCount;
                    STATE.lastCheckTimestamp = Date.now();
                    return;
                }
                
                // Detectar novos pedidos
                if (currentCount > STATE.lastPedidosCount) {
                    const diff = currentCount - STATE.lastPedidosCount;
                    const novos = pedidosNovos.slice(0, diff);
                    
                    // Agrupar e notificar
                    const grupos = {};
                    novos.forEach(p => {
                        const resp = p.RESPONSAVEL_PELO_CARTAO || 'Sem respons√°vel';
                        if (!grupos[resp]) {
                            grupos[resp] = { responsavel: resp, total: 0, quantidade: 0 };
                        }
                        grupos[resp].total += parseFloat(p.TOTAL_PAGAR) || 0;
                        grupos[resp].quantidade++;
                    });
                    
                    Object.values(grupos).forEach(sendPushNotification);
                }
                
                STATE.lastPedidosCount = currentCount;
                STATE.lastCheckTimestamp = Date.now();
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar pedidos:', error);
            }
        }

        // ========== API E DADOS ==========
        async function atualizarDados() {
            try {
                showNotification('Carregando...', 'info');
                
                document.getElementById('paymentsContainer').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Carregando dados...</p>
                    </div>
                `;

                const response = await fetch(`${CONFIG.API_URL}/pedidos`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const resultado = await response.json();

                if (resultado.success && resultado.data) {
                    STATE.dadosReais = resultado.data.filter(p => 
                        p.FECHAMENTO !== 'SIM' && 
                        p.FECHAMENTO !== 'Sim' && 
                        p.FECHAMENTO !== 'sim'
                    );
                    
                    aplicarFiltros();
                    showNotification(`‚úÖ ${STATE.dadosReais.length} pedidos carregados!`, 'success');
                } else {
                    throw new Error(resultado.error || 'Erro desconhecido');
                }

            } catch (error) {
                console.error('‚ùå Erro:', error);
                document.getElementById('paymentsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Erro de Conex√£o</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                showNotification(`Erro: ${error.message}`, 'error');
            }
        }

        function agruparPorDiaEResponsavel(dados) {
            const grupos = {};
            
            dados.forEach(pedido => {
                const dataEnvio = pedido.DATA_ENVIO1 ? new Date(pedido.DATA_ENVIO1).toDateString() : 'Sem data';
                const responsavel = pedido.RESPONSAVEL_PELO_CARTAO || 'Sem respons√°vel';
                const chave = `${dataEnvio}_${responsavel}`;
                
                if (!grupos[chave]) {
                    grupos[chave] = {
                        responsavel,
                        dataEnvio,
                        pedidos: [],
                        totalValue: 0,
                        firstPedido: pedido
                    };
                }
                
                grupos[chave].pedidos.push(pedido);
                grupos[chave].totalValue += parseFloat(pedido.TOTAL_PAGAR) || 0;
            });
            
            return Object.values(grupos);
        }

        // ========== FILTROS ==========
        function aplicarFiltros() {
            let dados = [...STATE.dadosReais];

            // Filtro por data
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            if (dataInicio || dataFim) {
                dados = dados.filter(pedido => {
                    if (!pedido.DATA_ENVIO1) return false;
                    
                    const dataEnvio = new Date(pedido.DATA_ENVIO1);
                    const inicio = dataInicio ? new Date(dataInicio) : null;
                    const fim = dataFim ? new Date(dataFim) : null;

                    if (inicio && dataEnvio < inicio) return false;
                    if (fim && dataEnvio > fim) return false;
                    return true;
                });
            }

            // Filtro por status
            if (STATE.filtroAtivo !== 'todos') {
                dados = dados.filter(pedido => {
                    switch (STATE.filtroAtivo) {
                        case 'pendente':
                            return !pedido.APROVADO_POR || pedido.APROVADO_POR.trim() === '';
                        case 'aprovado':
                            return pedido.APROVADO_POR && pedido.APROVADO_POR.trim() !== '' && pedido.DEPOSITADO !== 'DEPOSITADO';
                        case 'depositado':
                            return pedido.DEPOSITADO === 'DEPOSITADO';
                        default:
                            return true;
                    }
                });
            }

            STATE.dadosFiltrados = dados;
            renderizarPedidos();
        }

        function filtrarPorStatus(status) {
            STATE.filtroAtivo = status;
            
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            aplicarFiltros();
        }

        // ========== RENDERIZA√á√ÉO ==========
        function renderizarPedidos() {
            const container = document.getElementById('paymentsContainer');
            
            if (!STATE.dadosFiltrados || STATE.dadosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Nenhum pedido encontrado</h3>
                        <p>Verifique os filtros aplicados</p>
                    </div>
                `;
                return;
            }

            const grupos = agruparPorDiaEResponsavel(STATE.dadosFiltrados);

            const html = grupos.map((grupo, groupIndex) => {
                const { responsavel, totalValue, pedidos, firstPedido } = grupo;
                const pagcorp = firstPedido.PAGCORP || firstPedido.PAGCGORP || 'Sem c√≥digo';
                const quantidade = pedidos.length;
                const isDepositado = pedidos.every(p => p.DEPOSITADO === 'DEPOSITADO');
                const projeto = pedidos[0].PROJETO || 'N/A';

                const detalhesHtml = pedidos.map(p => `
                    <div class="pedido-individual">
                        <div class="detail-row">
                            <span class="detail-label">Valor:</span>
                            <span class="detail-value">R$ ${(parseFloat(p.TOTAL_PAGAR) || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Data:</span>
                            <span class="detail-value">${p.DATA_ENVIO1 ? new Date(p.DATA_ENVIO1).toLocaleDateString('pt-BR') : 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Projeto:</span>
                            <span class="detail-value">${p.PROJETO || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Tipo:</span>
                            <span class="detail-value">${p.TIPO_REFEICAO || 'N/A'}</span>
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="payment-card" data-group-id="${groupIndex}">
                        <div class="payment-header" onclick="togglePaymentDetails(${groupIndex})">
                            <input type="checkbox" class="payment-checkbox" data-group-index="${groupIndex}" 
                                   onchange="updateBulkActions()" onclick="event.stopPropagation()">
                            <div class="payment-main-content">
                                <div class="payment-title">${responsavel}</div>
                                <div style="font-size: 0.75rem; color: #666; margin: 2px 0;">${projeto}</div>
                                <div class="payment-main-info">
                                    <div>
                                        <div class="payment-subtitle">${pagcorp}</div>
                                        ${quantidade > 1 ? `<div style="font-size: 0.8rem; color: #666;">${quantidade} pedidos</div>` : ''}
                                    </div>
                                    <div class="payment-amount">
                                        <div class="amount-value">R$ ${totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                        ${isDepositado ? 
                                            '<span class="deposited-badge">‚úì OK</span>' : 
                                            `<button class="deposit-btn" onclick="depositarGrupo(${groupIndex})">$</button>`
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="payment-details">
                            <div class="payment-details-content">${detalhesHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function togglePaymentDetails(index) {
            document.querySelectorAll('.payment-card')[index]?.classList.toggle('expanded');
        }

        // ========== A√á√ïES DE DEP√ìSITO (OTIMIZADAS) ==========
        function atualizarUILocalmente(pedidos) {
            pedidos.forEach(pedido => {
                // Atualizar em dadosFiltrados
                const indexFiltrado = STATE.dadosFiltrados.findIndex(p => 
                    p.RESPONSAVEL_PELO_CARTAO === pedido.RESPONSAVEL_PELO_CARTAO && 
                    p.DATA_ENVIO1 === pedido.DATA_ENVIO1
                );
                if (indexFiltrado !== -1) {
                    STATE.dadosFiltrados[indexFiltrado].DEPOSITADO = 'DEPOSITADO';
                }
                
                // Atualizar em dadosReais
                const indexReal = STATE.dadosReais.findIndex(p => 
                    p.RESPONSAVEL_PELO_CARTAO === pedido.RESPONSAVEL_PELO_CARTAO && 
                    p.DATA_ENVIO1 === pedido.DATA_ENVIO1
                );
                if (indexReal !== -1) {
                    STATE.dadosReais[indexReal].DEPOSITADO = 'DEPOSITADO';
                }
            });
        }

        async function enviarDepositoParaServidor(pedidos) {
            const pedidosFormatados = pedidos.map(p => ({
                RESPONSAVEL_PELO_CARTAO: p.RESPONSAVEL_PELO_CARTAO,
                PAGCORP: p.PAGCORP,
                TOTAL_PAGAR: p.TOTAL_PAGAR
            }));
            
            const response = await fetch(`${CONFIG.API_URL}/pedidos/depositar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pedidos: pedidosFormatados })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            return response.json();
        }

        async function depositarGrupo(groupIndex) {
            try {
                const grupos = agruparPorDiaEResponsavel(STATE.dadosFiltrados);
                const grupo = grupos[groupIndex];
                
                // üöÄ Atualizar UI IMEDIATAMENTE
                atualizarUILocalmente(grupo.pedidos);
                aplicarFiltros();
                showNotification('‚úì Depositando...', 'info');
                
                // Enviar ao servidor em background
                const resultado = await enviarDepositoParaServidor(grupo.pedidos);
                
                if (resultado.success) {
                    showNotification(`‚úÖ ${resultado.pedidos_atualizados} depositado(s)!`, 'success');
                } else {
                    throw new Error(resultado.error);
                }
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                showNotification('‚úì Salvo localmente (servidor offline)', 'success');
            }
        }

        async function depositarSelecionados() {
            try {
                const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
                const grupos = agruparPorDiaEResponsavel(STATE.dadosFiltrados);
                
                let todosPedidos = [];
                
                checkboxes.forEach(cb => {
                    const groupIndex = parseInt(cb.dataset.groupIndex);
                    const grupo = grupos[groupIndex];
                    if (grupo) {
                        todosPedidos.push(...grupo.pedidos);
                    }
                });
                
                if (todosPedidos.length === 0) {
                    showNotification('Nenhum pedido selecionado', 'error');
                    return;
                }
                
                // üöÄ Atualizar UI IMEDIATAMENTE
                atualizarUILocalmente(todosPedidos);
                document.getElementById('selectAll').checked = false;
                updateBulkActions();
                aplicarFiltros();
                showNotification('‚úì Depositando...', 'info');
                
                // Enviar ao servidor
                const resultado = await enviarDepositoParaServidor(todosPedidos);
                
                if (resultado.success) {
                    showNotification(`‚úÖ ${resultado.pedidos_atualizados} depositado(s)!`, 'success');
                } else {
                    throw new Error(resultado.error);
                }
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                showNotification('‚úì Salvo localmente (servidor offline)', 'success');
            }
        }

        // ========== BULK ACTIONS ==========
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.payment-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const checked = document.querySelectorAll('.payment-checkbox:checked').length;
            const total = document.querySelectorAll('.payment-checkbox').length;
            const bulkBtn = document.getElementById('bulkDepositBtn');
            const selectAll = document.getElementById('selectAll');
            
            bulkBtn.disabled = checked === 0;
            selectAll.checked = checked === total && total > 0;
        }

        // ========== NOTIFICA√á√ïES UI ==========
        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                left: '50%',
                transform: 'translateX(-50%)',
                backgroundColor: type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6',
                color: 'white',
                padding: '1rem 1.5rem',
                borderRadius: '12px',
                boxShadow: '0 10px 25px rgba(0,0,0,0.2)',
                zIndex: '9999',
                fontSize: '0.9rem',
                fontWeight: '500',
                maxWidth: '90vw',
                animation: 'slideDown 0.3s ease-out'
            });

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataInicio').value = hoje;
            document.getElementById('dataFim').value = hoje;
            
            requestNotificationPermission();
        });
    </script>
</body>
</html>